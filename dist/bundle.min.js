(()=>{"use strict";const t=1e3,i={APP_ELEMENT:"#app",CANVAS_WIDTH:t,CANVAS_HEIGHT:600,GROUND_HEIGHT:60,GROUND_START_Y:540,GRAVITY:.4,STAGE_MAX_X:11e3},s=({max:t,min:i})=>Math.floor(Math.random()*t)+i;class e{constructor({player:t,stages:s,enemies:e}){this.player=t,this.stages=s,this.enemies=e,this.timer=0,this.keyboard=[],this.setKeyEvent();const h=document.querySelector(i.APP_ELEMENT),n=document.createElement("canvas"),[r,a]=[i.CANVAS_WIDTH,i.CANVAS_HEIGHT];[h.style.width,h.style.height]=[`${r}px`,`${a}px`],[n.width,n.height]=[r,a],this.ctx=n.getContext("2d"),h.appendChild(n)}setPlayer(t){this.player=t}setKeyEvent(){document.addEventListener("keydown",(t=>{this.keyboard=[...new Set([...this.keyboard,t.code])]})),document.addEventListener("keyup",(t=>{this.keyboard=this.keyboard.filter((i=>i!==t.code))}))}_draw(){this.ctx.fillStyle="maroon",this.ctx.fillRect(0,0,i.CANVAS_WIDTH,i.CANVAS_HEIGHT),this.ctx.fillStyle="darkslategray",this.ctx.fillRect(0,i.GROUND_START_Y,i.CANVAS_WIDTH,i.GROUND_HEIGHT);const t=this.player.realX;let s=0,e=i.CANVAS_WIDTH;t>=i.STAGE_MAX_X-i.CANVAS_WIDTH/2?(s=i.STAGE_MAX_X-i.CANVAS_WIDTH,e=i.STAGE_MAX_X):t>=i.CANVAS_WIDTH/2&&(s=t-i.CANVAS_WIDTH/2,e=t+i.CANVAS_WIDTH/2),this.stages.filter((t=>t.x+t.width>=s&&t.x<=e)).forEach((t=>{t.update(this),t.draw(this)})),this.enemies.filter((t=>t.x+t.startPosition+t.height>s&&t.x+t.startPosition-t.height<e)).forEach((t=>{t.update(this),t.draw(this)})),this.player.update(this),this.player.draw(this),this.timer=requestAnimationFrame(this._draw.bind(this))}getViewStages(t){const i=t.x+t.height/2;return this.stages.filter((t=>t.x<=i&&t.x+t.width>=i)).sort(((t,i)=>t.y<i.y?-1:1))}run(){this._draw()}}class h{constructor(t){this.options=t}update(t){}draw(t){}}const n=[{speed:1,jump:0,walkLength:100},{speed:1,jump:10,walkLength:200},{speed:3,jump:0,walkLength:100},{speed:2,jump:100,walkLength:200}];class r extends h{constructor(t){super(t),this.pattern=n[s({max:n.length,min:0})],this.x=0,this.yv=10,this.startPosition=t.startPosition,this.turn=!1,this.y=0,this.height=this.width=32,this.jumping=!1,this.standingPos=0,this.jumpTop=void 0,this.jumpingTimer=0,this.currentStage=void 0,this.downing=!1,this.downingTimer=0,this.moveImages=t.moveImages,this.imageIndex=0,this.timer=0}draw(t){let s=0;const e=i.CANVAS_WIDTH/2;t.player.realX<=e?s=0:t.player.realX>=e&&t.player.realX<=i.STAGE_MAX_X-e?s=t.player.realX-e:t.player.realX>=i.STAGE_MAX_X-e&&(s=i.STAGE_MAX_X-i.CANVAS_WIDTH);const h=this.turn?"trans":"normal",n=this.moveImages[h];let r=n[0];this.timer%5==0&&(this.imageIndex++,this.imageIndex>=n.length&&(this.imageIndex=0)),r=n[this.imageIndex],(this.jumping||this.downing)&&(r=n[0]),t.ctx.drawImage(r,this.x+this.startPosition-s,i.GROUND_START_Y+this.y-this.height,this.width,this.height)}update(t){this.x>=this.pattern.walkLength&&(this.turn=!0),this.x<=0&&(this.turn=!1),this.turn?this.x-=this.pattern.speed:this.x+=this.pattern.speed,!this.jumping&&this.pattern.jump>0&&this.x%this.pattern.jump==0&&(this.jumping=!0,this.standingPos=this.y,this.jumpTop=void 0,this.jumpingTimer=0);const i=t.getViewStages({x:this.x+this.startPosition,height:this.height});this.jumping&&this._jump(i),this.timer++}_jump(t){const s=this.y;this.y=this.standingPos+.5*i.GRAVITY*this.jumpingTimer*this.jumpingTimer-this.yv*this.jumpingTimer,this.jumpingTimer++,this.y>1&&this._reset();const e=s<this.y;e&&!this.jumpTop&&(this.jumpTop=s);const h=t.find((t=>this.jumpTop<=t.y-i.GROUND_START_Y&&s<=t.y-i.GROUND_START_Y&&this.y>=t.y-i.GROUND_START_Y));e&&h&&this._reset(h)}_reset(t){t?(this.y=t.y-t.height+this.height/2-i.GROUND_START_Y+5,this.jumping=!1,this.downing=!1,this.jumpTop=void 0,this.currentStage=t):(this.y=0,this.downing=!1,this.currentStage=void 0,this.jumping=!1,this.jumpTop=void 0)}}class a extends h{constructor(t){super(t),this.height=this.width=32,this.yv=10,this.xv=0,this.maxXV=5,this.realY=0,this.realX=0,this.viewY=0,this.viewX=0,this.moving=!1,this.movingTImer=0,this.movingImageIdx=0,this.turn=!1,this.jumping=!1,this.standingPos=0,this.jumpTop=void 0,this.jumpingTimer=0,this.currentStage=void 0,this.downing=!1,this.downingTimer=0,this.stopImage=t.stopImage,this.moveImages=t.moveImages}draw(t){const s=this.turn?"trans":"normal",e=this.moveImages[s];let h=this.stopImage[s];this.moving&&(this.movingTImer%5==0&&(this.movingImageIdx++,this.movingImageIdx>=e.length&&(this.movingImageIdx=0)),h=e[this.movingImageIdx]),(this.jumping||this.downing)&&(h=e[0]),t.ctx.drawImage(h,this.viewX,i.GROUND_START_Y+this.viewY-this.height,this.width,this.height)}update(t){if(t.keyboard.find((t=>"ArrowRight"===t))){this.moving=!0,this.turn=!1,this.realX+=2+this.xv,this.movingTImer++;const t=i.CANVAS_WIDTH/2;this.realX>=t&&this.realX<=i.STAGE_MAX_X-t?this.viewX=i.CANVAS_WIDTH/2:this.realX>=i.STAGE_MAX_X?(this.realX=i.STAGE_MAX_X,this.viewX=i.CANVAS_WIDTH):this.viewX+=2+this.xv}else if(t.keyboard.find((t=>"ArrowLeft"===t))){this.moving=!0,this.turn=!0,this.movingTImer++,this.realX-=2+this.xv;const t=i.CANVAS_WIDTH/2;this.realX>=t&&this.realX<=i.STAGE_MAX_X-t?this.viewX=i.CANVAS_WIDTH/2:this.realX<=0?this.realX=this.viewX=0:this.viewX-=2+this.xv}else this.moving=!1,this.xv=0,this.movingTImer=0;this.moving&&this.xv<=this.maxXV&&(this.xv+=.01),t.keyboard.find((t=>"ArrowUp"===t))&&!this.jumping&&(this.jumping=!0,this.standingPos=this.realY,this.jumpTop=void 0,this.jumpingTimer=0);const s=t.getViewStages({x:this.realX,height:this.height}),e=this.realX+this.height/2;this.currentStage&&(this.currentStage.x>e||this.currentStage.x+this.currentStage.width<e)&&!this.downing&&!this.jumping&&(this.downing=!0,this.standingPos=this.realY,this.downingTimer=0),this.jumping&&this._jump(s),this.downing&&this._down(s)}_jump(t){const s=this.realY;this.realY=this.standingPos+.5*i.GRAVITY*this.jumpingTimer*this.jumpingTimer-this.yv*this.jumpingTimer,this.jumpingTimer++,this.realY>1&&this._reset();const e=s<this.realY;e&&!this.jumpTop&&(this.jumpTop=s);const h=t.find((t=>this.jumpTop<=t.y-i.GROUND_START_Y&&s<=t.y-i.GROUND_START_Y&&this.realY>=t.y-i.GROUND_START_Y));e&&h&&this._reset(h),this.viewY=this.realY}_down(t){const s=this.realY;this.realY=.5*i.GRAVITY*this.downingTimer*this.downingTimer+this.standingPos,this.downingTimer++,this.realY>1&&this._reset();const e=t.find((t=>s<=t.y-i.GROUND_START_Y&&this.realY>=t.y-i.GROUND_START_Y));e&&this._reset(e),this.viewY=this.realY}_reset(t){t?(this.realY=t.y-t.height+this.height/2-i.GROUND_START_Y+5,this.jumping=!1,this.downing=!1,this.jumpTop=void 0,this.currentStage=t):(this.realY=0,this.downing=!1,this.currentStage=void 0,this.jumping=!1,this.jumpTop=void 0)}}class m extends h{constructor(t){super(t),this.width=s({max:300,min:100}),this.height=20,this.x=s({max:i.CANVAS_WIDTH+t.widthIndex*i.CANVAS_WIDTH,min:t.widthIndex*i.CANVAS_WIDTH}),this.y=s({max:i.GROUND_START_Y-50,min:1})}draw(t){t.ctx.strokeStyle="gray",t.ctx.fillStyle="#505050";let s=0;const e=i.CANVAS_WIDTH/2;t.player.realX<=e?s=0:t.player.realX>=e&&t.player.realX<=i.STAGE_MAX_X-e?s=t.player.realX-e:t.player.realX>=i.STAGE_MAX_X-e&&(s=i.STAGE_MAX_X-i.CANVAS_WIDTH),t.ctx.strokeRect(this.x-s,this.y,this.width,this.height),t.ctx.fillRect(this.x-s,this.y,this.width,this.height)}}const o=[new Image,new Image],g=[new Image,new Image],p=[new Image,new Image],d=[new Image,new Image];((t,i)=>{let s=0;for(var e=0;e<t.length;++e)t[e].onload=function(){++s,s==t.length&&i(t)}})([o[0],o[1],g[0],g[1],p[0],p[1],d[0],d[1]],(function(){const t=new a({stopImage:{normal:o[0],trans:o[1]},moveImages:{normal:[o[0],g[0]],trans:[o[1],g[1]]}});let h=[];for(let t=0;t<i.STAGE_MAX_X/i.CANVAS_WIDTH;t++){const i=s({max:10,min:3});h=h.concat([...Array(i)].map((()=>new m({widthIndex:t}))))}let n=[];for(let t=0;t<i.STAGE_MAX_X/i.CANVAS_WIDTH;t++){const e=s({max:3,min:1});n=n.concat([...Array(e)].map((()=>{const e=s({max:i.CANVAS_WIDTH+t*i.CANVAS_WIDTH,min:t*i.CANVAS_WIDTH});return new r({startPosition:e,moveImages:{normal:[p[0],d[0]],trans:[p[1],d[1]]}})})))}new e({player:t,stages:h,enemies:n}).run()})),o[0].src="./assets/images/player_stop.png",o[1].src="./assets/images/player_stop_trans.png",g[0].src="./assets/images/player_move.png",g[1].src="./assets/images/player_move_trans.png",p[0].src="./assets/images/enemy_stop.png",p[1].src="./assets/images/enemy_stop_trans.png",d[0].src="./assets/images/enemy_move.png",d[1].src="./assets/images/enemy_move_trans.png"})();