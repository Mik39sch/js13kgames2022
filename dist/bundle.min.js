(()=>{"use strict";const t=({max:t,min:e})=>Math.floor(Math.random()*t)+e,e=function(){const t=window.performance&&(performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow);return t&&t.call(performance)||(new Date).getTime()},i=1e3,s={APP_ELEMENT:"#app",CANVAS_WIDTH:i,CANVAS_HEIGHT:600,GROUND_HEIGHT:60,GROUND_START_Y:540,GRAVITY:.4,STAGE_MAX_X:11e3};class h{constructor(t){this.options=t}update(t){}draw(t){}}const r=[{speed:1,jump:0,walkLength:100},{speed:1,jump:10,walkLength:200},{speed:3,jump:0,walkLength:100},{speed:2,jump:100,walkLength:300},{speed:3,jump:100,walkLength:250}];class o extends h{constructor(e){super(e);let i=4;e.level&&(i=e.level+1,3===e.level&&(i=5)),this.pattern=r[t({max:i,min:0})],e.pattern&&(this.pattern=e.pattern),this.x=0,this.yv=10,this.startPosition=e.startPosition,this.turn=!1,this.y=0,this.height=this.width=32,e.size&&(this.height=this.width=e.size),this.jumping=!1,this.standingPos=0,this.jumpTop=void 0,this.jumpingTimer=0,this.currentStage=void 0,this.downing=!1,this.downingTimer=0,this.moveImages=e.moveImages,this.imageIndex=0,this.timer=0}draw(t,e){let i=0;const h=s.CANVAS_WIDTH/2;t.player.realX<=h?i=0:t.player.realX>=h&&t.player.realX<=t.stageMaxX-h?i=t.player.realX-h:t.player.realX>=t.stageMaxX-h&&(i=t.stageMaxX-s.CANVAS_WIDTH);const r=this.turn?"trans":"normal",o=this.moveImages[r];let a=o[0];this.timer%5==0&&(this.imageIndex++,this.imageIndex>=o.length&&(this.imageIndex=0)),a=o[this.imageIndex],(this.jumping||this.downing)&&(a=o[0]),e.drawImage(a,this.x+this.startPosition-i,s.GROUND_START_Y+this.y-this.height,this.width,this.height)}update(t){this.x>=this.pattern.walkLength&&(this.turn=!0),this.x<=0&&(this.turn=!1),this.turn?this.x-=this.pattern.speed:this.x+=this.pattern.speed,!this.jumping&&this.pattern.jump>0&&this.x%this.pattern.jump==0&&(this.jumping=!0,this.standingPos=this.y,this.jumpTop=void 0,this.jumpingTimer=0);const e=t.getViewStages({x:this.x+this.startPosition,height:this.height});this.jumping&&this._jump(e),this.timer++}_jump(t){const e=this.y;this.y=this.standingPos+.5*s.GRAVITY*this.jumpingTimer*this.jumpingTimer-this.yv*this.jumpingTimer,this.jumpingTimer++,this.y>1&&this._reset();const i=e<this.y;i&&!this.jumpTop&&(this.jumpTop=e);const h=t.find((t=>this.jumpTop<=t.y-s.GROUND_START_Y&&e<=t.y-s.GROUND_START_Y&&this.y>=t.y-s.GROUND_START_Y));i&&h&&this._reset(h)}_reset(t){t?(this.y=t.y-s.GROUND_START_Y,this.jumping=!1,this.downing=!1,this.jumpTop=void 0,this.currentStage=t):(this.y=0,this.downing=!1,this.currentStage=void 0,this.jumping=!1,this.jumpTop=void 0)}}class a extends h{constructor(t){super(t),this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y,this.color=t.color}draw(t,e){e.strokeStyle=this.color,e.fillStyle=this.color;let i=0;const h=s.CANVAS_WIDTH/2;t.player.realX<=h?i=0:t.player.realX>=h&&t.player.realX<=t.stageMaxX-h?i=t.player.realX-h:t.player.realX>=t.stageMaxX-h&&(i=t.stageMaxX-s.CANVAS_WIDTH),e.strokeRect(this.x-i,this.y,this.width,this.height),e.fillRect(this.x-i,this.y,this.width,this.height)}}const n={stage:[{width:150,height:100,x:700,y:440,color:"#5b5b5b"},{width:150,height:180,x:900,y:360,color:"#5b5b5b"},{width:150,height:270,x:1100,y:270,color:"#5b5b5b"},{width:150,height:25,x:1050,y:150,color:"white"},{width:150,height:30,x:1200,y:70,color:"white"},{width:130,height:30,x:1800,y:100,color:"white"},{width:20,height:240,x:2e3,y:300,color:"#5b5b5b"},{width:180,height:30,x:2300,y:60,color:"white"},{width:150,height:100,x:2700,y:440,color:"#5b5b5b"},{width:150,height:180,x:2900,y:360,color:"#5b5b5b"},{width:150,height:270,x:3100,y:270,color:"#5b5b5b"},{width:150,height:25,x:3050,y:150,color:"white"},{width:130,height:30,x:3400,y:100,color:"white"},{width:20,height:240,x:3600,y:300,color:"#5b5b5b"},{width:180,height:30,x:4200,y:60,color:"white"},{width:150,height:100,x:4700,y:440,color:"#5b5b5b"},{width:150,height:180,x:4900,y:360,color:"#5b5b5b"},{width:150,height:270,x:5100,y:270,color:"#5b5b5b"},{width:150,height:25,x:5050,y:150,color:"white"},{width:150,height:100,x:5700,y:440,color:"#5b5b5b"},{width:150,height:180,x:5900,y:360,color:"#5b5b5b"},{width:350,height:270,x:6100,y:270,color:"#5b5b5b"},{width:150,height:25,x:6050,y:150,color:"white"},{width:150,height:180,x:6500,y:360,color:"#5b5b5b"},{width:150,height:100,x:6700,y:440,color:"#5b5b5b"},{width:150,height:20,x:7e3,y:440,color:"#5b5b5b"},{width:150,height:20,x:7500,y:400,color:"#5b5b5b"},{width:150,height:20,x:8e3,y:140,color:"white"},{width:50,height:100,x:8500,y:440,color:"#5b5b5b"},{width:150,height:20,x:8300,y:100,color:"white"},{width:150,height:20,x:8750,y:40,color:"white"},{width:150,height:20,x:9300,y:140,color:"white"},{width:150,height:100,x:9500,y:440,color:"#5b5b5b"},{width:100,height:100,x:9700,y:440,color:"#5b5b5b"},{width:50,height:100,x:1e4,y:440,color:"#5b5b5b"},{width:500,height:10,x:1400,y:-10,color:"white"},{width:500,height:10,x:2e3,y:-10,color:"white"},{width:500,height:10,x:2600,y:-10,color:"white"},{width:500,height:10,x:3300,y:-10,color:"white"},{width:500,height:10,x:4e3,y:-10,color:"white"},{width:100,height:10,x:4600,y:-10,color:"white"},{width:500,height:10,x:4800,y:-10,color:"white"},{width:500,height:10,x:5400,y:-10,color:"white"},{width:500,height:10,x:6e3,y:-10,color:"white"},{width:500,height:10,x:6800,y:-10,color:"white"},{width:500,height:10,x:7400,y:-10,color:"white"},{width:500,height:10,x:8e3,y:-10,color:"white"},{width:500,height:10,x:8700,y:-10,color:"white"},{width:500,height:10,x:9300,y:-10,color:"white"}],boss_stage:[{width:100,height:20,x:50,y:440,color:"#5b5b5b"},{width:100,height:20,x:50,y:240,color:"#5b5b5b"},{width:100,height:20,x:50,y:40,color:"#5b5b5b"},{width:100,height:20,x:220,y:340,color:"#5b5b5b"},{width:100,height:20,x:220,y:140,color:"#5b5b5b"},{width:100,height:20,x:400,y:240,color:"#5b5b5b"},{width:100,height:20,x:400,y:40,color:"#5b5b5b"},{width:100,height:20,x:550,y:240,color:"#5b5b5b"},{width:100,height:20,x:550,y:40,color:"#5b5b5b"},{width:100,height:20,x:680,y:340,color:"#5b5b5b"},{width:100,height:20,x:680,y:140,color:"#5b5b5b"},{width:100,height:20,x:850,y:440,color:"#5b5b5b"},{width:100,height:20,x:850,y:240,color:"#5b5b5b"},{width:100,height:20,x:850,y:40,color:"#5b5b5b"}]};class l extends h{constructor(t){super(t);this.lifePoint={x:0,y:0,img:t.image,point:3,maxPoint:3},this.time={x:s.CANVAS_WIDTH-10,y:25,startTime:e(),nowTime:0},this.stageText={x:0,y:0}}draw(t,i){for(let e=0;e<this.lifePoint.point;e++)i.drawImage(this.lifePoint.img,this.lifePoint.x+e*t.player.width+5,this.lifePoint.y);let s=`STAGE ${t.level}`;t.level>3&&(s="BOSS STAGE"),i.beginPath(),i.textBaseline="left",i.textAlign="left",i.fillStyle="white",i.font="bold 20px Arial, meiryo, sans-serif",i.fillText(s,this.lifePoint.x+(this.lifePoint.maxPoint+1)*t.player.width,25),i.beginPath(),i.textBaseline="right",i.textAlign="right",i.fillText(Math.floor(e()-this.time.startTime/1e3)/1e3,this.time.x,this.time.y)}}class g{constructor({player:t,enemyMoveImages:e,enemyStopImages:i}){this.player=t,this.header=void 0,this.stages=[],this.enemies=[],this.enemyMoveImages=e,this.enemyStopImages=i,this.timer=0,this.keyboard=[],this.level=1,this.clear=!1,this.setKeyEvent(),this.clearTIme=0,this.stageMaxX=s.STAGE_MAX_X,this.gamemode="title";const h=document.querySelector(s.APP_ELEMENT),[r,o]=[s.CANVAS_WIDTH,s.CANVAS_HEIGHT];[h.style.width,h.style.height]=[`${r}px`,`${o}px`],this.offscreenEl=document.createElement("canvas"),[this.offscreenEl.width,this.offscreenEl.height]=[r,o],this.offscreenCtx=this.offscreenEl.getContext("2d");const a=document.createElement("canvas");[a.style.width,a.style.height]=[`${r}px`,`${o}px`],[a.width,a.height]=[r,o],this.ctx=a.getContext("2d"),h.appendChild(a)}setPlayer(t){this.player=t}setKeyEvent(){document.addEventListener("keydown",(t=>{this.keyboard=[...new Set([...this.keyboard,t.code])]})),document.addEventListener("keyup",(t=>{"title"===this.gamemode&&(this.gamemode="play",this.player.initialize(),this.header.time.startTime=e(),this._draw()),"gameover"===this.gamemode&&"Enter"===t.code&&(this.gamemode="title",this._draw()),this.keyboard=this.keyboard.filter((e=>e!==t.code))}))}_draw(){this.offscreenCtx.save(),"gameover"!==this.gamemode&&(this.offscreenCtx.fillStyle="maroon",this.offscreenCtx.fillRect(0,0,s.CANVAS_WIDTH,s.CANVAS_HEIGHT),this.offscreenCtx.fillStyle="#78882d",this.offscreenCtx.fillRect(0,s.GROUND_START_Y,s.CANVAS_WIDTH,s.GROUND_HEIGHT)),"title"===this.gamemode&&this._drawTitle(),"play"===this.gamemode&&this._drawGame(),"boss"===this.gamemode&&this._drawBoss(),"gameover"===this.gamemode&&this._drawGameover(),this.offscreenCtx.restore(),this.ctx.drawImage(this.offscreenEl,0,0),"play"!==this.gamemode&&"boss"!==this.gamemode||(this.timer=requestAnimationFrame(this._draw.bind(this)))}_drawTitle(){this.level=1,this.clear=!1,this.header=new l({image:this.player.stopImage.normal}),this.initializeStage(),this.stages.filter((t=>t.x+t.width>=0&&t.x<=s.CANVAS_WIDTH)).forEach((t=>{t.update(this),t.draw(this,this.offscreenCtx)})),this.offscreenCtx.font="bold 40px serif",this.offscreenCtx.fillStyle="white",this.offscreenCtx.textBaseline="center",this.offscreenCtx.textAlign="center";this.offscreenCtx.fillText("Lost Treasures 2",s.CANVAS_WIDTH/2,s.CANVAS_HEIGHT/3);const t=s.CANVAS_HEIGHT/3+50;let e="One day... There was a treasures hunter.\n";e+="He heard a rumor that there was some treasures in the cave.\n",e+="So he went to the cave but... He was lost!\n",e+="You need to navigate to the exit for him.\n",e+="\n",e+="----------------------------------------------------------\n",e+="ArrowKeys(Left/Right): move\n",e+="ArrowKeys(Up): jump\n",e+="----------------------------------------------------------\n",e+="\n",e+="Press any key to start a new game.",this.offscreenCtx.beginPath(),this.offscreenCtx.textBaseline="left",this.offscreenCtx.textAlign="left",this.offscreenCtx.font="bold 20px Arial, meiryo, sans-serif";for(var i=e.split("\n"),h=0,r=i.length;r>h;h++){var o=i[h],a=20;h&&(a+=24*h),this.offscreenCtx.fillText(o,20,t+a)}}initializeStage(){this.player.initialize(),this.stages=n.stage.map((t=>new a(t))),this.enemies=[];for(let e=0;e<this.stageMaxX/s.CANVAS_WIDTH;e++){const i=t({max:this.level+2,min:this.level});this.enemies=this.enemies.concat([...Array(i)].map((()=>{const i=t({max:s.CANVAS_WIDTH+e*s.CANVAS_WIDTH,min:e*s.CANVAS_WIDTH});return new o({level:this.level,startPosition:i,moveImages:{normal:[this.enemyStopImages[0],this.enemyMoveImages[0]],trans:[this.enemyStopImages[1],this.enemyMoveImages[1]]}})})))}this.enemies=[]}_drawGame(){const t=this.player.realX;let i=0,h=s.CANVAS_WIDTH;t>=this.stageMaxX-s.CANVAS_WIDTH/2?(i=this.stageMaxX-s.CANVAS_WIDTH,h=this.stageMaxX):t>=s.CANVAS_WIDTH/2&&(i=t-s.CANVAS_WIDTH/2,h=t+s.CANVAS_WIDTH/2),t>=s.STAGE_MAX_X&&(this.clear=!0,this.clearTIme=e(),this.level++,this.level>3?(this.stages=[],this.gamemode="boss",this.player.initialize()):this.initializeStage()),this.clear&&this.showCLearText();const r=this.enemies.filter((t=>t.x+t.startPosition+t.height>i&&t.x+t.startPosition-t.height<h));!this.player.hitting&&this._hit(this.enemies)&&this._hitAction(),this.stages.filter((t=>t.x+t.width>=i&&t.x<=h)).forEach((t=>{t.update(this),t.draw(this,this.offscreenCtx)})),r.forEach((t=>{t.update(this),t.draw(this,this.offscreenCtx)})),this.player.update(this),this.player.draw(this,this.offscreenCtx),this.header.draw(this,this.offscreenCtx)}_drawBoss(){0===this.stages.length&&(this.stages=n.boss_stage.map((t=>new a(t)))),0===this.enemies.length&&(this.enemies=[new o({size:128,pattern:{speed:1,jump:20,walkLength:600},startPosition:300,moveImages:{normal:[this.enemyStopImages[0],this.enemyMoveImages[0]],trans:[this.enemyStopImages[1],this.enemyMoveImages[1]]}})]),this.stages.forEach((t=>t.draw(this,this.offscreenCtx))),this.enemies.forEach((t=>{t.update(this),t.draw(this,this.offscreenCtx)})),!this.player.hitting&&this._hit(this.enemies)&&this._hitAction(),this.stageMaxX=s.CANVAS_WIDTH,this.player.update(this),this.player.draw(this,this.offscreenCtx),this.header.draw(this,this.offscreenCtx)}_drawGameover(){this.offscreenCtx.font="bold 40px serif",this.offscreenCtx.fillStyle="white",this.offscreenCtx.textBaseline="center",this.offscreenCtx.textAlign="center",this.offscreenCtx.fillText("GAME OVER... YOU ARE DEAD",s.CANVAS_WIDTH/2,s.CANVAS_HEIGHT/3)}getViewStages(t){const e=t.x+t.height/2;return this.stages.filter((t=>t.x<=e&&t.x+t.width>=e)).sort(((t,e)=>t.y<e.y?-1:1))}_hit(t){const e=this.player.realX,i=this.player.realX+this.player.width,s=this.player.realY-this.player.height,h=this.player.realY;return t.some((t=>{const r=t.x+t.startPosition+10,o=t.x+t.startPosition+t.width-10,a=t.y-t.height,n=t.y;return r<=e&&e<=o&&a<=s&&s<=n||r<=i&&i<=o&&a<=s&&s<=n||r<=e&&e<=o&&a<=h&&h<=n||r<=i&&i<=o&&a<=h&&h<=n}))}_hitAction(){this.header.lifePoint.point-=1,this.header.lifePoint.point<0&&(this.gamemode="gameover"),this.player.hitting=!0,this.player.hittingTimer=100}getStageKey(){return`stage${this.level}`}showCLearText(){this.offscreenCtx.font="bold 40px serif",this.offscreenCtx.fillStyle="white",this.offscreenCtx.textBaseline="center",this.offscreenCtx.textAlign="center";const t=`Stage${this.level} Clear!!!`;this.offscreenCtx.fillText(t,s.CANVAS_WIDTH/2,s.CANVAS_HEIGHT/3);Math.floor(e()-this.clearTIme/1e3)/1e3>=30&&(this.clear=!1)}run(){this._draw()}}class m extends h{constructor(t){super(t),this.height=this.width=32,this.maxXV=5,this.yv=10,this.initialize(),this.stopImage=t.stopImage,this.moveImages=t.moveImages}initialize(){this.xv=0,this.realY=0,this.realX=0,this.viewY=0,this.viewX=0,this.moving=!1,this.movingTImer=0,this.movingImageIdx=0,this.turn=!1,this.jumping=!1,this.standingPos=0,this.jumpTop=void 0,this.jumpingTimer=0,this.currentStage=void 0,this.downing=!1,this.downingTimer=0,this.hitting=!1,this.hittingTimer=0}draw(t,e){const i=this.turn?"trans":"normal",h=this.moveImages[i];let r=this.stopImage[i];this.moving&&(this.movingTImer%5==0&&(this.movingImageIdx++,this.movingImageIdx>=h.length&&(this.movingImageIdx=0)),r=h[this.movingImageIdx]),(this.jumping||this.downing)&&(r=h[0]),(!this.hitting||this.hittingTimer>0&&this.hittingTimer%2==0)&&e.drawImage(r,this.viewX,s.GROUND_START_Y+this.viewY-this.height)}update(t){if(t.keyboard.find((t=>"ArrowRight"===t))){this.moving=!0,this.turn=!1,this.realX+=2+this.xv,this.movingTImer++;const e=s.CANVAS_WIDTH/2;this.realX>=e&&this.realX<=t.stageMaxX-e?this.viewX=s.CANVAS_WIDTH/2:this.realX>=t.stageMaxX?(this.realX=t.stageMaxX,this.viewX=s.CANVAS_WIDTH):this.viewX+=2+this.xv}else if(t.keyboard.find((t=>"ArrowLeft"===t))){this.moving=!0,this.turn=!0,this.movingTImer++,this.realX-=2+this.xv;const e=s.CANVAS_WIDTH/2;this.realX>=e&&this.realX<=t.stageMaxX-e?this.viewX=s.CANVAS_WIDTH/2:this.realX<=0?this.realX=this.viewX=0:this.viewX-=2+this.xv}else this.moving=!1,this.xv=0,this.movingTImer=0;this.moving&&this.xv<=this.maxXV&&(this.xv+=.01),!t.keyboard.find((t=>"ArrowUp"===t))||this.jumping||this.downing||(this.jumping=!0,this.standingPos=this.realY,this.jumpTop=void 0,this.jumpingTimer=0);const e=t.getViewStages({x:this.realX,height:this.height}),i=this.realX+this.height/2;this.currentStage&&(this.currentStage.x>i||this.currentStage.x+this.currentStage.width<i)&&!this.downing&&!this.jumping&&(this.downing=!0,this.standingPos=this.realY,this.downingTimer=0),this.jumping&&this._jump(e),this.downing&&this._down(e),this.hitting&&(this.hittingTimer-=1,0===this.hittingTimer&&(this.hitting=!1))}_jump(t){const e=this.realY;this.realY=this.standingPos+.5*s.GRAVITY*this.jumpingTimer*this.jumpingTimer-this.yv*this.jumpingTimer,this.jumpingTimer++,this.realY>1&&this._reset();const i=e<this.realY;i&&!this.jumpTop&&(this.jumpTop=e);const h=t.find((t=>this.jumpTop<=t.y-s.GROUND_START_Y&&e<=t.y-s.GROUND_START_Y&&this.realY>=t.y-s.GROUND_START_Y));i&&h&&this._reset(h),this.viewY=this.realY}_down(t){const e=this.realY;this.realY=.5*s.GRAVITY*this.downingTimer*this.downingTimer+this.standingPos,this.downingTimer++,this.realY>1&&this._reset();const i=t.find((t=>e<=t.y-s.GROUND_START_Y&&this.realY>=t.y-s.GROUND_START_Y));i&&this._reset(i),this.viewY=this.realY}_reset(t){t?(this.realY=t.y-s.GROUND_START_Y,this.jumping=!1,this.downing=!1,this.jumpTop=void 0,this.currentStage=t):(this.realY=0,this.downing=!1,this.currentStage=void 0,this.jumping=!1,this.jumpTop=void 0)}}const d=[new Image,new Image],c=[new Image,new Image],w=[new Image,new Image],x=[new Image,new Image];((t,e)=>{let i=0;for(var s=0;s<t.length;++s)t[s].onload=function(){++i,i==t.length&&e(t)}})([d[0],d[1],c[0],c[1],w[0],w[1],x[0],x[1]],(function(){const t=new m({stopImage:{normal:d[0],trans:d[1]},moveImages:{normal:[d[0],c[0]],trans:[d[1],c[1]]}});new g({player:t,stages:[],enemies:[],enemyMoveImages:x,enemyStopImages:w}).run()})),d[0].src="./assets/images/player_stop.png",d[1].src="./assets/images/player_stop_trans.png",c[0].src="./assets/images/player_move.png",c[1].src="./assets/images/player_move_trans.png",w[0].src="./assets/images/enemy_stop.png",w[1].src="./assets/images/enemy_stop_trans.png",x[0].src="./assets/images/enemy_move.png",x[1].src="./assets/images/enemy_move_trans.png"})();